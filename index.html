<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭美食决策助手</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #28a745;
            --secondary-color: #6c757d;
            --accent-color: #ffc107;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding-top: 70px;
            color: #333;
        }
        
        .navbar {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            padding: 25px;
            transition: transform 0.3s;
        }
        
        .section-card:hover {
            transform: translateY(-5px);
        }
        
        .section-title {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .dish-card {
            border: none;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
            height: 100%;
        }
        
        .dish-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .dish-image {
            height: 180px;
            object-fit: cover;
        }
        
        .category-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--primary-color);
        }
        
        .rating {
            color: var(--accent-color);
            font-size: 1.1rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        
        .menu-item {
            background: #f8fff9;
            border-left: 4px solid var(--primary-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .random-result {
            background: #f0f9ff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1050;
            animation: fadeIn 0.3s, fadeOut 0.5s 2.5s forwards;
            max-width: 350px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        
        .stats-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            .section-card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .dish-image {
                height: 150px;
            }
            
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-success fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-egg-fried me-2"></i>家庭美食决策助手
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#dishes-section"><i class="bi bi-list-ul me-1"></i>菜品管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#random-section"><i class="bi bi-shuffle me-1"></i>随机选择</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#menu-section"><i class="bi bi-card-checklist me-1"></i>今日菜单</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 欢迎部分 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="section-card text-center">
                    <h2>告别"不知道吃什么"的困扰</h2>
                    <p class="lead">轻松管理家庭菜品，随机选择每日菜单，让饮食规划变得更简单</p>
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="stats-card">
                                <div class="stats-number" id="total-dishes">0</div>
                                <div>菜品总数</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card">
                                <div class="stats-number" id="today-menu-count">0</div>
                                <div>今日菜品</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card">
                                <div class="stats-number" id="popular-count">0</div>
                                <div>最受欢迎</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 菜品列表部分 -->
        <section id="dishes-section" class="mb-4">
            <div class="section-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="section-title m-0">菜品管理</h3>
                    <button class="btn btn-primary" id="add-dish-btn">
                        <i class="bi bi-plus-circle me-1"></i>添加菜品
                    </button>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="categoryFilter" class="form-label">按分类筛选</label>
                        <select class="form-select" id="categoryFilter">
                            <option value="all">所有分类</option>
                            <option value="家常菜">家常菜</option>
                            <option value="汤类">汤类</option>
                            <option value="面食">面食</option>
                            <option value="米饭">米饭</option>
                            <option value="早餐">早餐</option>
                            <option value="甜品">甜品</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="searchDish" class="form-label">搜索菜品</label>
                        <input type="text" class="form-control" id="searchDish" placeholder="输入菜品名称">
                    </div>
                </div>
                
                <div id="dishes-list" class="row">
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-success"></div>
                        <p class="mt-2">加载中...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 随机选择部分 -->
        <section id="random-section" class="mb-4">
            <div class="section-card">
                <h3 class="section-title">随机选择</h3>
                <div class="text-center">
                    <button id="random-btn" class="btn btn-primary btn-lg">
                        <i class="bi bi-shuffle me-2"></i>随机选择菜品
                    </button>
                    
                    <div id="random-result" class="random-result mt-4" style="display: none;">
                        <h4 class="text-center mb-3">今日推荐</h4>
                        <div id="random-dish" class="mb-3"></div>
                        <div class="text-center">
                            <button id="add-to-menu-btn" class="btn btn-success me-2">
                                <i class="bi bi-plus-circle me-1"></i>加入今日菜单
                            </button>
                            <button id="random-again-btn" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-repeat me-1"></i>再选一次
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 今日菜单部分 -->
        <section id="menu-section" class="mb-4">
            <div class="section-card">
                <h3 class="section-title">今日菜单</h3>
                <div id="today-menu">
                    <div class="text-center py-4">
                        <div class="spinner-border text-success spinner-border-sm"></div>
                        <p class="mt-2">加载中...</p>
                    </div>
                </div>
            </div>
            
            <div class="section-card">
                <h3 class="section-title">最常选择的菜品</h3>
                <div id="popular-dishes">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary spinner-border-sm"></div>
                        <p class="mt-2">加载中...</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- 添加/编辑菜品的模态框 -->
    <div class="modal fade" id="dishModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">添加菜品</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="dish-form">
                        <input type="hidden" id="dish-id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dish-name" class="form-label">菜名 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="dish-name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dish-category" class="form-label">分类 <span class="text-danger">*</span></label>
                                <select class="form-select" id="dish-category" required>
                                    <option value="家常菜">家常菜</option>
                                    <option value="汤类">汤类</option>
                                    <option value="面食">面食</option>
                                    <option value="米饭">米饭</option>
                                    <option value="早餐">早餐</option>
                                    <option value="甜品">甜品</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dish-image" class="form-label">图片URL</label>
                            <input type="text" class="form-control" id="dish-image" placeholder="https://example.com/image.jpg">
                            <div class="form-text">可选，如果不提供将显示默认图片</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">推荐指数 <span class="text-danger">*</span></label>
                            <div class="d-flex">
                                <div class="rating me-3">
                                    <span class="star" data-value="1">☆</span>
                                    <span class="star" data-value="2">☆</span>
                                    <span class="star" data-value="3">☆</span>
                                    <span class="star" data-value="4">☆</span>
                                    <span class="star" data-value="5">☆</span>
                                </div>
                                <input type="hidden" id="dish-rating" value="3">
                                <span id="rating-text" class="text-muted">3星</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dish-ingredients" class="form-label">制作原料（每行一个）</label>
                            <textarea class="form-control" id="dish-ingredients" rows="3" placeholder="土豆&#10;胡萝卜&#10;牛肉"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dish-steps" class="form-label">制作流程（每行一个步骤）</label>
                            <textarea class="form-control" id="dish-steps" rows="4" placeholder="1. 准备食材&#10;2. 切块&#10;3. 炒制"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-dish-btn">保存菜品</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-4 mt-5">
        <div class="container">
            <p class="mb-0">家庭美食决策助手 &copy; 2023 - 让每餐都充满惊喜</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.21.0"></script>
    <script>
        // Supabase初始化 - 请替换为您的配置
        const SUPABASE_URL = 'https://gdhdlxnuopyargiqnwwz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkaGRseG51b3B5YXJnaXFud3d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MzQ2NjUsImV4cCI6MjA3MjExMDY2NX0.0FsiUZypPMuxgn3E9Xi9F06PSEMQV1zqWQmr7YALDLo';
        
        // 初始化Supabase客户端
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // 全局状态
        let dishes = [];
        let todayMenu = [];
        let currentDishId = null;
        let currentRandomDish = null;
        
        // DOM加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
        
        // 初始化应用
        function initApp() {
            // 初始化事件监听
            initEventListeners();
            
            // 加载数据
            loadData();
        }
        
        // 初始化事件监听
        function initEventListeners() {
            // 分类筛选
            document.getElementById('categoryFilter').addEventListener('change', function() {
                filterDishes();
            });
            
            // 搜索菜品
            document.getElementById('searchDish').addEventListener('input', function() {
                filterDishes();
            });
            
            // 添加菜品按钮
            document.getElementById('add-dish-btn').addEventListener('click', function() {
                showDishModal();
            });
            
            // 保存菜品
            document.getElementById('save-dish-btn').addEventListener('click', saveDish);
            
            // 随机选择菜品
            document.getElementById('random-btn').addEventListener('click', randomSelectDish);
            
            // 再次随机选择
            document.getElementById('random-again-btn').addEventListener('click', randomSelectDish);
            
            // 添加到今日菜单
            document.getElementById('add-to-menu-btn').addEventListener('click', addToTodayMenu);
            
            // 评分星星点击事件
            document.querySelectorAll('.rating .star').forEach(star => {
                star.addEventListener('click', function() {
                    const value = parseInt(this.getAttribute('data-value'));
                    setRating(value);
                });
            });
            
            // 使用事件委托处理动态生成的元素
            document.getElementById('dishes-list').addEventListener('click', function(e) {
                if (e.target.classList.contains('view-detail')) {
                    const dishId = e.target.getAttribute('data-id');
                    showDishDetail(dishId);
                } else if (e.target.classList.contains('edit-dish')) {
                    const dishId = e.target.getAttribute('data-id');
                    editDish(dishId);
                } else if (e.target.classList.contains('delete-dish')) {
                    const dishId = e.target.getAttribute('data-id');
                    deleteDish(dishId);
                }
            });
            
            document.getElementById('today-menu').addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-from-menu')) {
                    const menuId = e.target.getAttribute('data-id');
                    removeFromTodayMenu(menuId);
                }
            });
        }
        
        // 加载数据
        function loadData() {
            loadDishes();
            loadTodayMenu();
            loadPopularDishes();
        }
        
        // 从Supabase加载菜品数据
        async function loadDishes() {
            try {
                const { data, error } = await supabase
                    .from('dishes')
                    .select('*')
                    .order('name');
                    
                if (error) throw error;
                
                dishes = data;
                renderDishes(dishes);
                updateStats();
            } catch (error) {
                console.error('加载菜品错误:', error);
                showNotification('加载菜品失败，请刷新重试', 'danger');
            }
        }
        
        // 渲染菜品列表
        function renderDishes(dishesToRender) {
            const dishesList = document.getElementById('dishes-list');
            
            if (dishesToRender.length === 0) {
                dishesList.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-inbox display-4 text-muted"></i>
                        <p class="mt-3 text-muted">暂无菜品，点击右上角添加第一个菜品</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            dishesToRender.forEach(dish => {
                const stars = '★'.repeat(dish.rating) + '☆'.repeat(5 - dish.rating);
                const imageUrl = dish.image_url || 'https://placehold.co/600x400?text=无图片';
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card dish-card">
                            <span class="badge category-badge">${dish.category}</span>
                            <img src="${imageUrl}" class="dish-image card-img-top" alt="${dish.name}" onerror="this.src='https://placehold.co/600x400?text=图片加载失败'">
                            <div class="card-body">
                                <h5 class="card-title">${dish.name}</h5>
                                <div class="rating mb-2">${stars}</div>
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-sm btn-outline-primary view-detail" data-id="${dish.id}">查看详情</button>
                                    <button class="btn btn-sm btn-outline-secondary edit-dish" data-id="${dish.id}">编辑</button>
                                    <button class="btn btn-sm btn-outline-danger delete-dish" data-id="${dish.id}">删除</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            dishesList.innerHTML = html;
        }
        
        // 过滤菜品
        function filterDishes() {
            const category = document.getElementById('categoryFilter').value;
            const searchText = document.getElementById('searchDish').value.toLowerCase();
            
            let filteredDishes = dishes;
            
            // 按分类筛选
            if (category !== 'all') {
                filteredDishes = filteredDishes.filter(dish => dish.category === category);
            }
            
            // 按搜索文本筛选
            if (searchText) {
                filteredDishes = filteredDishes.filter(dish => 
                    dish.name.toLowerCase().includes(searchText)
                );
            }
            
            renderDishes(filteredDishes);
        }
        
        // 显示菜品详情
        async function showDishDetail(dishId) {
            try {
                const dish = dishes.find(d => d.id == dishId);
                
                if (!dish) {
                    showNotification('未找到菜品信息', 'warning');
                    return;
                }
                
                // 在实际应用中，这里可以显示一个详情模态框
                // 现在我们先简单显示一个提示
                showNotification(`查看菜品: ${dish.name}`, 'info');
                
            } catch (error) {
                console.error('获取菜品详情错误:', error);
                showNotification('获取菜品详情失败', 'danger');
            }
        }
        
        // 显示添加/编辑菜品模态框
        function showDishModal(dishId = null) {
            const modal = new bootstrap.Modal(document.getElementById('dishModal'));
            const modalTitle = document.getElementById('modalTitle');
            
            if (dishId) {
                // 编辑模式
                modalTitle.textContent = '编辑菜品';
                const dish = dishes.find(d => d.id == dishId);
                
                if (dish) {
                    document.getElementById('dish-id').value = dish.id;
                    document.getElementById('dish-name').value = dish.name;
                    document.getElementById('dish-image').value = dish.image_url || '';
                    document.getElementById('dish-category').value = dish.category;
                    setRating(dish.rating);
                    document.getElementById('dish-ingredients').value = dish.ingredients || '';
                    document.getElementById('dish-steps').value = dish.steps || '';
                }
            } else {
                // 添加模式
                modalTitle.textContent = '添加菜品';
                document.getElementById('dish-form').reset();
                setRating(3);
            }
            
            modal.show();
        }
        
        // 设置评分
        function setRating(value) {
            document.getElementById('dish-rating').value = value;
            document.getElementById('rating-text').textContent = `${value}星`;
            
            const stars = document.querySelectorAll('.rating .star');
            stars.forEach(star => {
                const starValue = parseInt(star.getAttribute('data-value'));
                if (starValue <= value) {
                    star.textContent = '★';
                } else {
                    star.textContent = '☆';
                }
            });
        }
        
        // 保存菜品
        async function saveDish() {
            const id = document.getElementById('dish-id').value;
            const name = document.getElementById('dish-name').value;
            const imageUrl = document.getElementById('dish-image').value;
            const category = document.getElementById('dish-category').value;
            const rating = document.getElementById('dish-rating').value;
            const ingredients = document.getElementById('dish-ingredients').value;
            const steps = document.getElementById('dish-steps').value;
            
            if (!name) {
                showNotification('请输入菜品名称', 'warning');
                return;
            }
            
            try {
                const dishData = {
                    name,
                    image_url: imageUrl || null,
                    category,
                    rating: parseInt(rating),
                    ingredients,
                    steps,
                    updated_at: new Date().toISOString()
                };
                
                if (id) {
                    // 更新现有菜品
                    const { error } = await supabase
                        .from('dishes')
                        .update(dishData)
                        .eq('id', id);
                    
                    if (error) throw error;
                    showNotification('菜品更新成功', 'success');
                } else {
                    // 添加新菜品
                    dishData.created_at = new Date().toISOString();
                    const { error } = await supabase
                        .from('dishes')
                        .insert([dishData]);
                    
                    if (error) throw error;
                    showNotification('菜品添加成功', 'success');
                }
                
                // 关闭模态框并重新加载数据
                bootstrap.Modal.getInstance(document.getElementById('dishModal')).hide();
                loadDishes();
                
            } catch (error) {
                console.error('保存菜品错误:', error);
                showNotification('保存菜品失败', 'danger');
            }
        }
        
        // 编辑菜品
        function editDish(dishId) {
            showDishModal(dishId);
        }
        
        // 删除菜品
        async function deleteDish(dishId) {
            if (!confirm('确定要删除这个菜品吗？此操作不可恢复。')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('dishes')
                    .delete()
                    .eq('id', dishId);
                    
                if (error) throw error;
                
                showNotification('菜品删除成功', 'success');
                loadDishes();
                
            } catch (error) {
                console.error('删除菜品错误:', error);
                showNotification('删除菜品失败', 'danger');
            }
        }
        
        // 随机选择菜品
        function randomSelectDish() {
            if (dishes.length === 0) {
                showNotification('请先添加一些菜品', 'warning');
                return;
            }
            
            // 随机选择一个菜品
            const randomIndex = Math.floor(Math.random() * dishes.length);
            const randomDish = dishes[randomIndex];
            currentRandomDish = randomDish;
            
            // 显示随机结果
            const stars = '★'.repeat(randomDish.rating) + '☆'.repeat(5 - randomDish.rating);
            const imageUrl = randomDish.image_url || 'https://placehold.co/600x400?text=无图片';
            
            document.getElementById('random-dish').innerHTML = `
                <div class="card border-0">
                    <img src="${imageUrl}" class="card-img-top rounded" style="height: 200px; object-fit: cover;" alt="${randomDish.name}" onerror="this.src='https://placehold.co/600x400?text=图片加载失败'">
                    <div class="card-body text-center">
                        <h5 class="card-title">${randomDish.name}</h5>
                        <p class="text-muted">${randomDish.category}</p>
                        <div class="rating mb-2">${stars}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('random-result').style.display = 'block';
        }
        
        // 添加到今日菜单
        async function addToTodayMenu() {
            if (!currentRandomDish) return;
            
            try {
                // 获取当前日期
                const today = new Date().toISOString().split('T')[0];
                
                // 检查是否已添加到今日菜单
                const { data: existing, error: checkError } = await supabase
                    .from('menu_records')
                    .select('id')
                    .eq('dish_id', currentRandomDish.id)
                    .gte('added_date', today)
                    .lte('added_date', today);
                    
                if (checkError) throw checkError;
                
                if (existing && existing.length > 0) {
                    showNotification('该菜品已在今日菜单中', 'warning');
                    return;
                }
                
                // 添加到菜单记录
                const { error } = await supabase
                    .from('menu_records')
                    .insert([{
                        dish_id: currentRandomDish.id,
                        added_date: today,
                        created_at: new Date().toISOString()
                    }]);
                    
                if (error) throw error;
                
                showNotification('已添加到今日菜单', 'success');
                loadTodayMenu();
                loadPopularDishes();
                
            } catch (error) {
                console.error('添加到菜单错误:', error);
                showNotification('添加到菜单失败', 'danger');
            }
        }
        
        // 加载今日菜单
        async function loadTodayMenu() {
            try {
                // 获取当前日期
                const today = new Date().toISOString().split('T')[0];
                
                const { data, error } = await supabase
                    .from('menu_records')
                    .select(`
                        id,
                        dishes (
                            id, name, category, image_url, rating
                        )
                    `)
                    .gte('added_date', today)
                    .lte('added_date', today)
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                todayMenu = data.map(record => ({
                    menu_id: record.id,
                    ...record.dishes
                }));
                
                renderTodayMenu();
                updateStats();
            } catch (error) {
                console.error('加载今日菜单错误:', error);
            }
        }
        
        // 渲染今日菜单
        function renderTodayMenu() {
            const todayMenuElement = document.getElementById('today-menu');
            
            if (todayMenu.length === 0) {
                todayMenuElement.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-card-checklist display-4 text-muted"></i>
                        <p class="mt-3 text-muted">今日菜单为空，请从随机选择中添加菜品</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            todayMenu.forEach(dish => {
                const stars = '★'.repeat(dish.rating) + '☆'.repeat(5 - dish.rating);
                const imageUrl = dish.image_url || 'https://placehold.co/100x100?text=无图片';
                
                html += `
                    <div class="menu-item">
                        <div class="d-flex align-items-center">
                            <img src="${imageUrl}" class="rounded me-3" width="60" height="60" style="object-fit: cover;" alt="${dish.name}" onerror="this.src='https://placehold.co/100x100?text=图片加载失败'">
                            <div>
                                <h6 class="mb-0">${dish.name}</h6>
                                <small class="text-muted">${dish.category} · ${stars}</small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger remove-from-menu" data-id="${dish.menu_id}">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                `;
            });
            
            todayMenuElement.innerHTML = html;
        }
        
        // 从今日菜单移除
        async function removeFromTodayMenu(menuId) {
            try {
                const { error } = await supabase
                    .from('menu_records')
                    .delete()
                    .eq('id', menuId);
                    
                if (error) throw error;
                
                showNotification('已从今日菜单移除', 'success');
                loadTodayMenu();
                
            } catch (error) {
                console.error('移除菜单项错误:', error);
                showNotification('移除菜单项失败', 'danger');
            }
        }
        
        // 加载热门菜品
        async function loadPopularDishes() {
            try {
                // 使用原始SQL查询获取热门菜品
                const { data, error } = await supabase
                    .from('menu_records')
                    .select(`
                        dish_id,
                        dishes (
                            id, name, category, rating
                        )
                    `);
                    
                if (error) throw error;
                
                // 手动统计菜品出现次数
                const dishCountMap = {};
                data.forEach(record => {
                    const dishId = record.dish_id;
                    if (dishCountMap[dishId]) {
                        dishCountMap[dishId].count++;
                    } else {
                        dishCountMap[dishId] = {
                            count: 1,
                            dish: record.dishes
                        };
                    }
                });
                
                // 转换为数组并排序
                const popularDishesArray = Object.values(dishCountMap)
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5);
                
                renderPopularDishes(popularDishesArray);
                updateStats();
            } catch (error) {
                console.error('加载热门菜品错误:', error);
            }
        }
        
        // 渲染热门菜品
        function renderPopularDishes(popularDishes) {
            const popularDishesElement = document.getElementById('popular-dishes');
            
            if (!popularDishes || popularDishes.length === 0) {
                popularDishesElement.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-graph-up display-4 text-muted"></i>
                        <p class="mt-3 text-muted">暂无数据</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="list-group">';
            
            popularDishes.forEach((item, index) => {
                const stars = '★'.repeat(item.dish.rating) + '☆'.repeat(5 - item.dish.rating);
                
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-primary me-2">${index + 1}</span>
                            <span class="fw-bold">${item.dish.name}</span>
                            <small class="text-muted d-block">${item.dish.category} · ${stars}</small>
                        </div>
                        <span class="badge bg-success rounded-pill">${item.count}次</span>
                    </div>
                `;
            });
            
            html += '</div>';
            
            popularDishesElement.innerHTML = html;
        }
        
        // 更新统计信息
        function updateStats() {
            document.getElementById('total-dishes').textContent = dishes.length;
            document.getElementById('today-menu-count').textContent = todayMenu.length;
            
            // 计算最受欢迎菜品的次数
            const popularCount = document.querySelectorAll('#popular-dishes .badge.rounded-pill');
            if (popularCount.length > 0) {
                const maxCount = Math.max(...Array.from(popularCount).map(badge => parseInt(badge.textContent)));
                document.getElementById('popular-count').textContent = maxCount || 0;
            } else {
                document.getElementById('popular-count').textContent = 0;
            }
        }
        
        // 显示通知
        function showNotification(message, type = 'info') {
            // 移除现有通知
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} notification`;
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'danger' ? 'bi-exclamation-circle' : 'bi-info-circle'} me-2"></i>
                    <div>${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3秒后自动移除
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
    </script>
</body>
</html>
