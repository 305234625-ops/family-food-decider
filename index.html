<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭美食助手</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #ff7b54;
            --secondary: #ffb26b;
            --accent: #ffd56b;
            --success: #939b62;
            --light: #fff6e4;
            --dark: #3d3d3d;
            --danger: #ff6b6b;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --radius: 16px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f9f9f9;
            color: var(--dark);
            line-height: 1.6;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 100%;
            padding: 0 16px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .app-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            padding: 4px;
            margin-top: 16px;
        }
        
        .nav-tab {
            padding: 8px 16px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .nav-tab.active {
            background: white;
            color: var(--primary);
        }
        
        .section {
            display: none;
            margin-top: 24px;
            animation: fadeIn 0.5s ease;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }
        
        .card:active {
            transform: scale(0.98);
        }
        
        .dish-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 12px;
        }
        
        .dish-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        .dish-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .tag {
            background: var(--light);
            padding: 4px 10px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .rating {
            color: var(--accent);
            margin-bottom: 12px;
        }
        
        .actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn {
            padding: 10px 16px;
            border-radius: 50px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:active {
            background: var(--secondary);
        }
        
        .btn-secondary {
            background: var(--light);
            color: var(--dark);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        .floating-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 16px rgba(255, 123, 84, 0.4);
            z-index: 90;
            border: none;
            cursor: pointer;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            justify-content: center;
            align-items: center;
            padding: 16px;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark);
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 1rem;
        }
        
        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        
        .filter-btn {
            background: white;
            padding: 8px 16px;
            border-radius: 50px;
            border: 1px solid #eee;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .random-container {
            text-align: center;
            padding: 40px 20px;
        }
        
        .random-dish {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 20px 0;
            color: var(--primary);
        }
        
        .stats-container {
            margin-top: 24px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #aaa;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            color: #ddd;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="app-bar">
                <div class="logo">
                    <i class="fas fa-utensils"></i>
                    <span>家庭美食助手</span>
                </div>
            </div>
            <div class="nav-tabs">
                <div class="nav-tab active" data-target="dishes">菜品列表</div>
                <div class="nav-tab" data-target="menu">今日菜单</div>
                <div class="nav-tab" data-target="random">随机选择</div>
                <div class="nav-tab" data-target="stats">热门统计</div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- 菜品列表部分 -->
        <section id="dishes" class="section active">
            <div class="filter-bar">
                <button class="filter-btn active" data-category="all">全部</button>
                <button class="filter-btn" data-category="家常菜">家常菜</button>
                <button class="filter-btn" data-category="汤类">汤类</button>
                <button class="filter-btn" data-category="面食">面食</button>
                <button class="filter-btn" data-category="凉菜">凉菜</button>
                <button class="filter-btn" data-category="甜品">甜品</button>
            </div>
            
            <div id="dishes-list">
                <!-- 菜品列表将通过JavaScript动态生成 -->
                <div class="empty-state">
                    <i class="fas fa-utensils"></i>
                    <p>暂无菜品，请添加您的第一道菜</p>
                </div>
            </div>
        </section>

        <!-- 今日菜单部分 -->
        <section id="menu" class="section">
            <h2>今日菜单</h2>
            <div id="menu-list">
                <!-- 菜单列表将通过JavaScript动态生成 -->
                <div class="empty-state">
                    <i class="fas fa-clipboard-list"></i>
                    <p>今日菜单为空，请添加菜品</p>
                </div>
            </div>
            
            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-primary" id="generate-shopping-list">
                    <i class="fas fa-shopping-basket"></i> 生成购物清单
                </button>
                <button class="btn btn-danger" id="clear-menu">
                    <i class="fas fa-trash"></i> 清空菜单
                </button>
            </div>
        </section>

        <!-- 随机选择部分 -->
        <section id="random" class="section">
            <div class="random-container">
                <h2>不知道吃什么？试试随机选择</h2>
                <button class="btn btn-primary" id="random-btn" style="margin: 20px 0;">
                    <i class="fas fa-random"></i> 随机选择菜品
                </button>
                
                <div id="random-result">
                    <!-- 随机结果将通过JavaScript动态生成 -->
                </div>
            </div>
        </section>

        <!-- 热门统计部分 -->
        <section id="stats" class="section">
            <h2>最受欢迎的菜品</h2>
            <p>根据添加到菜单的次数统计</p>
            
            <div class="stats-container" id="stats-list">
                <!-- 统计列表将通过JavaScript动态生成 -->
                <div class="empty-state">
                    <i class="fas fa-chart-line"></i>
                    <p>暂无统计信息</p>
                </div>
            </div>
        </section>
    </main>

    <!-- 添加菜品按钮 -->
    <button class="floating-btn" id="add-dish-btn">
        <i class="fas fa-plus"></i>
    </button>

    <!-- 添加/编辑菜品模态框 -->
    <div class="modal" id="dish-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">添加新菜品</h2>
                <button class="close-btn">&times;</button>
            </div>
            <form id="dish-form">
                <input type="hidden" id="dish-id">
                
                <div class="form-group">
                    <label for="dish-name">菜名</label>
                    <input type="text" id="dish-name" required>
                </div>
                
                <div class="form-group">
                    <label for="dish-image">图片URL</label>
                    <input type="text" id="dish-image" placeholder="输入图片链接">
                </div>
                
                <div class="form-group">
                    <label for="dish-category">分类</label>
                    <select id="dish-category" required>
                        <option value="家常菜">家常菜</option>
                        <option value="汤类">汤类</option>
                        <option value="面食">面食</option>
                        <option value="凉菜">凉菜</option>
                        <option value="甜品">甜品</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="dish-tags">标签（用逗号分隔）</label>
                    <input type="text" id="dish-tags" placeholder="例如：辣,下饭,简单">
                </div>
                
                <div class="form-group">
                    <label>推荐指数</label>
                    <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                        <span>1星</span>
                        <span>2星</span>
                        <span>3星</span>
                        <span>4星</span>
                        <span>5星</span>
                    </div>
                    <input type="range" id="dish-rating" min="1" max="5" value="3" style="width: 100%;">
                </div>
                
                <div class="form-group">
                    <label for="dish-ingredients">原料（每行一个原料）</label>
                    <textarea id="dish-ingredients" rows="4"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="dish-steps">制作流程（每行一个步骤）</label>
                    <textarea id="dish-steps" rows="4"></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">保存菜品</button>
            </form>
        </div>
    </div>

    <!-- 菜品详情模态框 -->
    <div class="modal" id="detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="detail-title">菜品详情</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div id="detail-content">
                <!-- 详情内容将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <!-- 引入Supabase客户端库 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // 初始化Supabase
        const supabaseUrl = 'https://gdhdlxnuopyargiqnwwz.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkaGRseG51b3B5YXJnaXFud3d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MzQ2NjUsImV4cCI6MjA3MjExMDY2NX0.0FsiUZypPMuxgn3E9Xi9F06PSEMQV1zqWQmr7YALDLo';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // DOM元素
        const navTabs = document.querySelectorAll('.nav-tab');
        const sections = document.querySelectorAll('.section');
        const addDishBtn = document.getElementById('add-dish-btn');
        const dishModal = document.getElementById('dish-modal');
        const detailModal = document.getElementById('detail-modal');
        const closeBtns = document.querySelectorAll('.close-btn');
        const dishForm = document.getElementById('dish-form');
        const dishesList = document.getElementById('dishes-list');
        const menuList = document.getElementById('menu-list');
        const statsList = document.getElementById('stats-list');
        const randomBtn = document.getElementById('random-btn');
        const randomResult = document.getElementById('random-result');
        const filterBtns = document.querySelectorAll('.filter-btn');
        const generateListBtn = document.getElementById('generate-shopping-list');
        const clearMenuBtn = document.getElementById('clear-menu');
        
        // 当前选中的分类过滤器
        let currentFilter = 'all';
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            // 加载菜品数据
            loadDishes();
            
            // 加载今日菜单
            loadMenu();
            
            // 加载统计数据
            loadStats();
            
            // 设置事件监听器
            setupEventListeners();
        });
        
        // 设置事件监听器
        function setupEventListeners() {
            // 导航标签点击
            navTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.getAttribute('data-target');
                    
                    // 更新活动标签
                    navTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // 显示对应部分
                    sections.forEach(section => {
                        section.classList.remove('active');
                        if (section.id === target) {
                            section.classList.add('active');
                        }
                    });
                });
            });
            
            // 分类过滤器点击
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    currentFilter = btn.getAttribute('data-category');
                    loadDishes();
                });
            });
            
            // 打开添加菜品模态框
            addDishBtn.addEventListener('click', () => {
                document.getElementById('modal-title').textContent = '添加新菜品';
                dishForm.reset();
                document.getElementById('dish-id').value = '';
                dishModal.style.display = 'flex';
            });
            
            // 关闭模态框
            closeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    dishModal.style.display = 'none';
                    detailModal.style.display = 'none';
                });
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', (e) => {
                if (e.target === dishModal) {
                    dishModal.style.display = 'none';
                }
                if (e.target === detailModal) {
                    detailModal.style.display = 'none';
                }
            });
            
            // 表单提交
            dishForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const dishId = document.getElementById('dish-id').value;
                const dishData = {
                    name: document.getElementById('dish-name').value,
                    image: document.getElementById('dish-image').value,
                    category: document.getElementById('dish-category').value,
                    tags: document.getElementById('dish-tags').value.split(',').map(tag => tag.trim()),
                    rating: parseInt(document.getElementById('dish-rating').value),
                    ingredients: document.getElementById('dish-ingredients').value.split('\n').filter(i => i.trim()),
                    steps: document.getElementById('dish-steps').value.split('\n').filter(s => s.trim()),
                    menu_count: 0
                };
                
                if (dishId) {
                    // 更新现有菜品
                    await updateDish(dishId, dishData);
                } else {
                    // 添加新菜品
                    await addDish(dishData);
                }
                
                // 关闭模态框并重新加载数据
                dishModal.style.display = 'none';
                loadDishes();
            });
            
            // 随机选择菜品
            randomBtn.addEventListener('click', async () => {
                const { data: dishes, error } = await supabase
                    .from('dishes')
                    .select('*');
                
                if (error) {
                    console.error('Error fetching dishes:', error);
                    return;
                }
                
                if (dishes.length === 0) {
                    randomResult.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>暂无菜品，请先添加菜品</p>
                        </div>
                    `;
                    return;
                }
                
                // 随机选择一道菜
                const randomDish = dishes[Math.floor(Math.random() * dishes.length)];
                
                randomResult.innerHTML = `
                    <div class="card">
                        <img src="${randomDish.image || 'https://via.placeholder.com/300x180?text=暂无图片'}" alt="${randomDish.name}" class="dish-image">
                        <h3 class="dish-title">${randomDish.name}</h3>
                        <div class="dish-tags">
                            <span class="tag">${randomDish.category}</span>
                            ${randomDish.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                        <div class="rating">
                            ${'★'.repeat(randomDish.rating)}${'☆'.repeat(5 - randomDish.rating)}
                        </div>
                        <div class="actions">
                            <button class="btn btn-secondary view-detail" data-id="${randomDish.id}">
                                <i class="fas fa-info-circle"></i> 详情
                            </button>
                            <button class="btn btn-primary add-to-menu" data-id="${randomDish.id}">
                                <i class="fas fa-plus"></i> 加入菜单
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                        <button class="btn btn-secondary" id="random-again">
                            <i class="fas fa-random"></i> 再随机一次
                        </button>
                    </div>
                `;
                
                // 添加事件监听器
                document.querySelector('.view-detail').addEventListener('click', function() {
                    const dishId = this.getAttribute('data-id');
                    showDishDetail(dishId);
                });
                
                document.querySelector('.add-to-menu').addEventListener('click', function() {
                    const dishId = this.getAttribute('data-id');
                    addToMenu(dishId);
                });
                
                document.getElementById('random-again').addEventListener('click', () => {
                    randomBtn.click();
                });
            });
            
            // 生成购物清单
            generateListBtn.addEventListener('click', generateShoppingList);
            
            // 清空菜单
            clearMenuBtn.addEventListener('click', clearMenu);
        }
        
        // 加载菜品列表
        async function loadDishes() {
            let query = supabase.from('dishes').select('*');
            
            if (currentFilter !== 'all') {
                query = query.eq('category', currentFilter);
            }
            
            const { data: dishes, error } = await query.order('name');
            
            if (error) {
                console.error('Error loading dishes:', error);
                return;
            }
            
            if (dishes.length === 0) {
                dishesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-utensils"></i>
                        <p>暂无菜品，请添加您的第一道菜</p>
                    </div>
                `;
                return;
            }
            
            dishesList.innerHTML = dishes.map(dish => `
                <div class="card">
                    ${dish.image ? `<img src="${dish.image}" alt="${dish.name}" class="dish-image">` : ''}
                    <h3 class="dish-title">${dish.name}</h3>
                    <div class="dish-tags">
                        <span class="tag">${dish.category}</span>
                        ${dish.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                    <div class="rating">
                        ${'★'.repeat(dish.rating)}${'☆'.repeat(5 - dish.rating)}
                    </div>
                    <div class="actions">
                        <button class="btn btn-secondary btn-sm view-detail" data-id="${dish.id}">
                            <i class="fas fa-info-circle"></i> 详情
                        </button>
                        <button class="btn btn-primary btn-sm add-to-menu" data-id="${dish.id}">
                            <i class="fas fa-plus"></i> 菜单
                        </button>
                        <button class="btn btn-secondary btn-sm edit-dish" data-id="${dish.id}">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        <button class="btn btn-danger btn-sm delete-dish" data-id="${dish.id}">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </div>
                </div>
            `).join('');
            
            // 添加事件监听器
            document.querySelectorAll('.view-detail').forEach(btn => {
                btn.addEventListener('click', function() {
                    const dishId = this.getAttribute('data-id');
                    showDishDetail(dishId);
                });
            });
            
            document.querySelectorAll('.add-to-menu').forEach(btn => {
                btn.addEventListener('click', function() {
                    const dishId = this.getAttribute('data-id');
                    addToMenu(dishId);
                });
            });
            
            document.querySelectorAll('.edit-dish').forEach(btn => {
                btn.addEventListener('click', function() {
                    const dishId = this.getAttribute('data-id');
                    editDish(dishId);
                });
            });
            
            document.querySelectorAll('.delete-dish').forEach(btn => {
                btn.addEventListener('click', function() {
                    const dishId = this.getAttribute('data-id');
                    deleteDish(dishId);
                });
            });
        }
        
        // 显示菜品详情
        async function showDishDetail(dishId) {
            const { data: dish, error } = await supabase
                .from('dishes')
                .select('*')
                .eq('id', dishId)
                .single();
            
            if (error) {
                console.error('Error fetching dish details:', error);
                return;
            }
            
            document.getElementById('detail-title').textContent = dish.name;
            
            document.getElementById('detail-content').innerHTML = `
                ${dish.image ? `<img src="${dish.image}" alt="${dish.name}" style="width: 100%; border-radius: 12px; margin-bottom: 16px;">` : ''}
                <div class="dish-tags" style="margin-bottom: 16px;">
                    <span class="tag">${dish.category}</span>
                    ${dish.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                </div>
                <div class="rating" style="margin-bottom: 16px;">
                    推荐指数: ${'★'.repeat(dish.rating)}${'☆'.repeat(5 - dish.rating)}
                </div>
                
                <h3 style="margin: 20px 0 10px;">原料</h3>
                <ul style="padding-left: 20px; margin-bottom: 20px;">
                    ${dish.ingredients.map(ingredient => `<li>${ingredient}</li>`).join('')}
                </ul>
                
                <h3 style="margin: 20px 0 10px;">制作流程</h3>
                <ol style="padding-left: 20px;">
                    ${dish.steps.map((step, index) => `<li>${step}</li>`).join('')}
                </ol>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" id="add-to-menu-from-detail" data-id="${dish.id}">
                    <i class="fas fa-plus"></i> 加入今日菜单
                </button>
            `;
            
            detailModal.style.display = 'flex';
            
            document.getElementById('add-to-menu-from-detail').addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                addToMenu(id);
                detailModal.style.display = 'none';
            });
        }
        
        // 编辑菜品
        async function editDish(dishId) {
            const { data: dish, error } = await supabase
                .from('dishes')
                .select('*')
                .eq('id', dishId)
                .single();
            
            if (error) {
                console.error('Error fetching dish for edit:', error);
                return;
            }
            
            document.getElementById('modal-title').textContent = '编辑菜品';
            document.getElementById('dish-id').value = dish.id;
            document.getElementById('dish-name').value = dish.name;
            document.getElementById('dish-image').value = dish.image || '';
            document.getElementById('dish-category').value = dish.category;
            document.getElementById('dish-tags').value = dish.tags.join(', ');
            document.getElementById('dish-rating').value = dish.rating;
            document.getElementById('dish-ingredients').value = dish.ingredients.join('\n');
            document.getElementById('dish-steps').value = dish.steps.join('\n');
            
            dishModal.style.display = 'flex';
        }
        
        // 添加菜品
        async function addDish(dishData) {
            const { data, error } = await supabase
                .from('dishes')
                .insert([dishData])
                .select();
            
            if (error) {
                console.error('Error adding dish:', error);
                alert('添加菜品失败');
            } else {
                console.log('Dish added successfully:', data);
            }
        }
        
        // 更新菜品
        async function updateDish(dishId, dishData) {
            const { data, error } = await supabase
                .from('dishes')
                .update(dishData)
                .eq('id', dishId)
                .select();
            
            if (error) {
                console.error('Error updating dish:', error);
                alert('更新菜品失败');
            } else {
                console.log('Dish updated successfully:', data);
            }
        }
        
        // 删除菜品
        async function deleteDish(dishId) {
            if (!confirm('确定要删除这个菜品吗？此操作不可撤销。')) {
                return;
            }
            
            const { error } = await supabase
                .from('dishes')
                .delete()
                .eq('id', dishId);
            
            if (error) {
                console.error('Error deleting dish:', error);
                alert('删除菜品失败');
            } else {
                console.log('Dish deleted successfully');
                loadDishes();
            }
        }
        
        // 加载今日菜单
        async function loadMenu() {
            const { data: menuItems, error } = await supabase
                .from('menu')
                .select(`
                    id,
                    dishes (*)
                `)
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('Error loading menu:', error);
                return;
            }
            
            if (menuItems.length === 0) {
                menuList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>今日菜单为空，请添加菜品</p>
                    </div>
                `;
                return;
            }
            
            menuList.innerHTML = menuItems.map(item => `
                <div class="menu-item">
                    <div>
                        <h4>${item.dishes.name}</h4>
                        <div class="dish-tags">
                            <span class="tag">${item.dishes.category}</span>
                        </div>
                    </div>
                    <button class="btn btn-danger btn-sm remove-from-menu" data-id="${item.id}">
                        <i class="fas fa-times"></i> 移除
                    </button>
                </div>
            `).join('');
            
            // 添加事件监听器
            document.querySelectorAll('.remove-from-menu').forEach(btn => {
                btn.addEventListener('click', function() {
                    const menuId = this.getAttribute('data-id');
                    removeFromMenu(menuId);
                });
            });
        }
        
        // 添加到菜单
        async function addToMenu(dishId) {
            // 首先检查是否已在菜单中
            const { data: existing, error: checkError } = await supabase
                .from('menu')
                .select('*')
                .eq('dish_id', dishId);
            
            if (checkError) {
                console.error('Error checking menu:', checkError);
                return;
            }
            
            if (existing.length > 0) {
                alert('该菜品已在今日菜单中');
                return;
            }
            
            // 添加到菜单
            const { error } = await supabase
                .from('menu')
                .insert([{ dish_id: dishId }]);
            
            if (error) {
                console.error('Error adding to menu:', error);
                alert('添加到菜单失败');
            } else {
                // 更新菜品的菜单计数
                const { data: dish } = await supabase
                    .from('dishes')
                    .select('menu_count')
                    .eq('id', dishId)
                    .single();
                
                await supabase
                    .from('dishes')
                    .update({ menu_count: (dish.menu_count || 0) + 1 })
                    .eq('id', dishId);
                
                alert('已添加到今日菜单');
                loadMenu();
                loadStats();
            }
        }
        
        // 从菜单中移除
        async function removeFromMenu(menuId) {
            const { error } = await supabase
                .from('menu')
                .delete()
                .eq('id', menuId);
            
            if (error) {
                console.error('Error removing from menu:', error);
                alert('从菜单中移除失败');
            } else {
                loadMenu();
            }
        }
        
        // 清空菜单
        async function clearMenu() {
            if (!confirm('确定要清空今日菜单吗？此操作不可撤销。')) {
                return;
            }
            
            const { error } = await supabase
                .from('menu')
                .delete()
                .neq('id', 0); // 删除所有记录
            
            if (error) {
                console.error('Error clearing menu:', error);
                alert('清空菜单失败');
            } else {
                loadMenu();
            }
        }
        
        // 加载统计数据
        async function loadStats() {
            const { data: dishes, error } = await supabase
                .from('dishes')
                .select('*')
                .order('menu_count', { ascending: false })
                .limit(10);
            
            if (error) {
                console.error('Error loading stats:', error);
                return;
            }
            
            if (dishes.length === 0) {
                statsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-line"></i>
                        <p>暂无统计信息</p>
                    </div>
                `;
                return;
            }
            
            statsList.innerHTML = dishes.map((dish, index) => `
                <div class="stat-item">
                    <div>
                        <span style="font-weight: 700;">${index + 1}. ${dish.name}</span>
                        <div class="dish-tags">
                            <span class="tag">${dish.category}</span>
                            <span class="tag">${dish.menu_count || 0} 次</span>
                        </div>
                    </div>
                    <div class="rating">
                        ${'★'.repeat(dish.rating)}${'☆'.repeat(5 - dish.rating)}
                    </div>
                </div>
            `).join('');
        }
        
        // 生成购物清单
        async function generateShoppingList() {
            const { data: menuItems, error } = await supabase
                .from('menu')
                .select(`
                    dishes (ingredients)
                `);
            
            if (error) {
                console.error('Error generating shopping list:', error);
                return;
            }
            
            if (menuItems.length === 0) {
                alert('今日菜单为空，无法生成购物清单');
                return;
            }
            
            // 合并所有原料
            const allIngredients = {};
            menuItems.forEach(item => {
                item.dishes.ingredients.forEach(ingredient => {
                    const trimmed = ingredient.trim();
                    if (trimmed) {
                        allIngredients[trimmed] = (allIngredients[trimmed] || 0) + 1;
                    }
                });
            });
            
            // 生成购物清单文本
            let shoppingList = "今日菜单购物清单:\n\n";
            for (const [ingredient, count] of Object.entries(allIngredients)) {
                shoppingList += `- ${ingredient}${count > 1 ? ` (x${count})` : ''}\n`;
            }
            
            alert(shoppingList);
        }
        
        // 初始化一些示例数据（首次运行时）
        async function initSampleData() {
            const { data: existingDishes, error } = await supabase
                .from('dishes')
                .select('*')
                .limit(1);
            
            if (error) {
                console.error('Error checking for existing dishes:', error);
                return;
            }
            
            if (existingDishes.length === 0) {
                const sampleDishes = [
                    {
                        name: "番茄炒蛋",
                        image: "https://images.unsplash.com/photo-1582515073490-3995cbaca692?w=400",
                        category: "家常菜",
                        tags: ["简单", "下饭"],
                        rating: 5,
                        ingredients: ["番茄 2个", "鸡蛋 3个", "盐 适量", "糖 少许", "葱花 适量"],
                        steps: ["番茄洗净切块", "鸡蛋打散加盐", "热油炒熟鸡蛋盛出", "炒番茄至出汁", "加入鸡蛋翻炒", "加盐和糖调味", "撒上葱花出锅"],
                        menu_count: 0
                    },
                    {
                        name: "红烧肉",
                        image: "https://images.unsplash.com/photo-1551966775-a5f6c5746a6f?w=400",
                        category: "家常菜",
                        tags: ["下饭", "红烧"],
                        rating: 4,
                        ingredients: ["五花肉 500g", "生姜 几片", "料酒 2勺", "老抽 1勺", "冰糖 适量", "八角 2个", "桂皮 1小块"],
                        steps: ["五花肉切块焯水", "炒糖色", "加入肉块翻炒", "加入调料和适量水", "小火炖煮40分钟", "大火收汁"],
                        menu_count: 0
                    },
                    {
                        name: "清炒西兰花",
                        image: "https://images.unsplash.com/photo-1512058564366-18510be2db19?w=400",
                        category: "家常菜",
                        tags: ["素菜", "健康"],
                        rating: 4,
                        ingredients: ["西兰花 1个", "大蒜 3瓣", "盐 适量", "食用油 适量"],
                        steps: ["西兰花洗净切小朵", "焯水1分钟", "热油爆香蒜末", "加入西兰花翻炒", "加盐调味出锅"],
                        menu_count: 0
                    }
                ];
                
                for (const dish of sampleDishes) {
                    await supabase
                        .from('dishes')
                        .insert([dish]);
                }
                
                console.log('Sample data initialized');
                loadDishes();
            }
        }
        
        // 初始化示例数据
        initSampleData();
    </script>
</body>
</html>
